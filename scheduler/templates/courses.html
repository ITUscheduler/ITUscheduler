{% extends "base.html" %}

{% block title %}Courses | ITU Scheduler{% endblock %}

{% block body %}
    <div class="container">
        <div class="row">
            <div class="col-md-2"> <!-- Detailed search section -->
                <h3>Find the exact course you want</h3><br>
                <form action="{{ request.path }}" method="GET">
                    <div class="row">
                        <div class="form-group col-md-12">
                            <select class="form-control" name="search_course" onchange="getCodesForSearch(this.form.search_course, '', true)">
                                {% if searched_course or searched_course == "all" %}
                                    <option value="{{ searched_course }}">{{ searched_course }}</option>
                                {% else %}
                                    <option value="all">Major Codes</option>
                                {% endif %}
                                {% for course in major_codes %}
                                    <option value="{{ course }}">{{ course }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-12" id="select_search_codes">
                            <select class="form-control" name="search_code">
                                <option value="all">Major Codes</option>
                            </select>
                        </div>
                        <div class="form-group col-md-12 col-xs-12" id="select_search_days">
                            <select class="form-control" name="search_day">
                                {% if searched_day %}
                                    <option value="{{ searched_day }}">{{ searched_day }}</option>
                                    {% if searched_day != "all" %}
                                        <option value="all">Days</option>
                                    {% endif %}
                                {% else %}
                                    <option value="all">Days</option>
                                {% endif %}
                                <option value="Pazartesi">Monday</option>
                                <option value="Salı">Tuesday</option>
                                <option value="Çarşamba">Wednesday</option>
                                <option value="Perşembe">Thursday</option>
                                <option value="Cuma">Friday</option>
                            </select>
                        </div>
                        <div class="form-group col-md-12 col-xs-12">
                            <input type="submit" value="Get me these" class="btn btn-primary">
                        </div>
                    </div>
                </form>
                <br>
                {% if unaccepted %}
                    <div class="alert alert-danger">Cannot get all the courses at once.</div>
                {% else %}
                    {% if searched_course or searched_code or searched_day %}
                        <div class="alert alert-info">For <strong>{{ searched_course }}</strong> courses, you are looking for courses with code <strong>{{ searched_code }}</strong> on day <strong>{{ searched_day }}</strong></div>
                    {% endif %}
                {% endif %}
            </div>
            <div class="col-md-10">
                <div class="panel panel-primary">
                    <!-- Default panel contents -->
                    <div class="panel-heading">
                        <h2 class="panel-title">Courses</h2>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-4 col-xs-12">
                                <form id="form_major_code">
                                    <select class="form-control" name="major_code" onchange="redirectQuery()" title="major_code">
                                        {% for option in major_codes %}
                                            {% if not searched_course or searched_course == "all" %}
                                                <option {% if option.code in request.path %}selected{% endif %} value="{{ option }}">{{ option }} </option>
                                            {% endif %}
                                            {% if searched_course %}
                                                <option {% if option.code == searched_course %}selected{% endif %} value="{{ option }}">{{ option }} </option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </form>
                            </div>
                            <div class="col-md-4 col-xs-12">
                                <form id="form_code">
                                    <select class="form-control" name="code" onchange="redirectQuery()">
                                        {% if code %}
                                            <option value="{{ code }}">{{ code }}</option>
                                        {% else %}
                                            <option selected value="">Please select a code below.</option>
                                        {% endif %}
                                        {% for code in codes %}
                                            <option value="{{ code }}">{{ code }}</option>
                                        {% endfor %}
                                    </select>
                                </form>
                            </div>
                            <div class="col-md-4 col-xs-12">
                                <form id="form_semester">
                                    <select class="form-control" name="semester" onchange="redirectQuery()">
                                        {% for semester in semesters %}
                                            <option {% if semester == searched_semester %}selected {% endif %}value="{{ semester }}">{{ semester.get_name_display }}</option>
                                        {% endfor %}
                                    </select>
                                </form>
                            </div>
                        </div>
                    </div>
                    <ul class="list-group">
                        <li class="list-group-item">
                            <div class="table-responsive">
                                <table class="table table-hover table-striped">
                                    <thead>
                                    <tr>
                                        {% if request.user.is_authenticated %}
                                            <th>My Courses</th>
                                        {% endif %}
                                        <th>CRN</th>
                                        <th>Major Code</th>
                                        <th>Title</th>
                                        <th>Instructor</th>
                                        <th>Building</th>
                                        <th>Day</th>
                                        <th>Time</th>
                                        <th>Room</th>
                                        <th>Capacity</th>
                                        <th>Major Restriction</th>
                                        <th>Prerequisites</th>
                                        <th>Class Restriction</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for course in courses %}
                                        <tr>
                                            {% if request.user.is_authenticated %}
                                                <td>
                                                    <label>
                                                        <input class="checkbox-inline" {% if course.crn in my_courses %}checked {% endif %}onchange="addCourse({{course.crn}})" type="checkbox">
                                                    </label>
                                                </td>
                                            {% endif %}
                                            <th>{{ course.crn }}</th>
                                            <td><a target="_blank" href="{{ course.catalogue }}">{{ course.code }}</a></td>
                                            <td>{{ course.title }}</td>
                                            <td>{{ course.instructor }}</td>
                                            <td><a href="javascript:listBuildings();">{% for lecture in course.lecture_set.all %}{{ lecture.building }}<br>{% endfor %}</a></td>
                                            <td>{% for lecture in course.lecture_set.all %}{{ lecture.day }}<br>{% endfor %}</td>
                                            <td>{% for lecture in course.lecture_set.all %}{{ lecture.time_str_tuple|join:"/" }}<br>{% endfor %}</td>
                                            <td>{% for lecture in course.lecture_set.all %}{{ lecture.room }}<br>{% endfor %}</td>
                                            <td>{{ course.enrolled }}/{{ course.capacity }}</td>
                                            <td><a href="javascript:alert('Major Restrictions: {{ course.major_restriction.all|join:", " }}')">{{ course.major_restriction.all|join:"<br>"|truncatechars:40 }}</a></td>
                                            <td><a href="javascript:alert('Prerequisites: {{ course.prerequisites.all|join:" or " }}')">{{ course.prerequisites.all|join:" or <br>"|truncatechars:40 }}</a></td>
                                            <td>{{ course.class_restriction }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <p>Latest Database Refresh: {{ refreshed }}</p>
            </div>
        </div>
    </div>
    <script>
        function redirectQuery() {
            var major_code = document.getElementById("form_major_code").major_code;
            var code = document.getElementById("form_code").code;
            var semester = document.getElementById("form_semester").semester;
            var url = new URL("/courses/" + major_code.options[major_code.selectedIndex].value, location.origin);
            url.searchParams.append("code", code.options[code.selectedIndex].value);
            url.searchParams.append("semester", semester.options[semester.selectedIndex].value);
            console.log(url);
            location = url;
        }

        function addCourse(courseCrn) {
            console.log("works");
            $.post(
                "{% url "add_course" %}",
                {
                    "course_crn": parseInt(courseCrn),
                    "csrfmiddlewaretoken": getCookie('csrftoken')
                },
                function(response) {
                    var isSuccessful = response["successful"];
                    if (!isSuccessful) {
                        alert("Error: " + response["error"] + "\nMy Courses: " + response["courses"]);
                    }
                },
                "json"
            )
        }

        function getCodesForSearch(selected, rememberedQuery, onchange) {
            var major_code_value = "BLG";
            if (rememberedQuery === '') {
                major_code_value = selected.options[selected.selectedIndex].value;
            } else {
                major_code_value = rememberedQuery;
            }

            var codes = [];

            $.ajax({
                url: "/rest-api/courses/" + major_code_value,
                type: "GET",

                success: function(data) {
                    $.each(data, function(index, value) {
                        if ($.inArray(value.code, codes) === -1) {
                            codes.push(value.code);
                        }
                    });

                    var html = "";
                    {% if searched_code %}
                        if (onchange === false) {
                            html += "<select class='form-control' name='search_code'>\n<option value='{{ searched_code }}'>{{ searched_code }}</option>\n<option value='all'>Major Codes</option>";
                        } else {
                            html += "<select class='form-control' name='search_code'>\n<option value='all'>Major Codes</option>";
                        }
                    {% else %}
                        html += "<select class='form-control' name='search_code'>\n<option value='all'>Major Codes</option>";
                    {% endif %}

                    $.each(codes, function(index, value) {
                        html += "<option value='" + value + "'>" + value + "</option>";
                    });

                    html += "</select>";
                    $("#select_search_codes").html(html);
                },
                error: function(error) {
                    console.log(error);
                }
            });
        }

        {% if searched_course %}
            getCodesForSearch('', '{{ searched_course }}', false);
        {% endif %}
    </script>
{% endblock %}
